<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">  
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.6.5/fabric.min.js"></script>
	<script type="text/javascript">
                
        function init( jQuery ) {
	    function createCanvas() {
		
		var wallCanvasContainer = document.getElementById("wall-canvas-container");
	        wallCanvasContainer.className = "";   
	        //var wallCanvasFabric = new fabric.Canvas("wall-canvas");
                wallCanvasFabric.setWidth(document.getElementById("wall-width").value);
                wallCanvasFabric.setHeight(document.getElementById("wall-height").value);	    
		wallCanvasFabric.renderAll();
	    }

            function blockDragStart(e) {
		[].forEach.call(wallBlocks, function(block) {
                    block.classList.remove("current-img-dragged");
		});
                this.classList.add("current-img-dragged");

                var dragImage = new Image();

		if (this.id == "block1x1") {
		    dragImage.src = "block1x1.png";
		}
		else if (this.id == "block1x2") {
		    dragImage.src = "block1x2.png";
		}
		else if (this.id == "block2x2") {
		    dragImage.src = "block2x2.png";
		}
		e.dataTransfer.setDragImage(dragImage, this.offsetWidth / 2, this.offsetHeight / 2);
	    }

            function blockDrag(e) {
		var canvasRect = wallCanvas.getBoundingClientRect();

                var block = document.querySelector("img.current-img-dragged");

		var blockTop = e.clientY - block.offsetHeight / 2;
	        var blockBottom = blockTop + block.offsetHeight;
	        var blockLeft = e.clientX - block.offsetWidth / 2;	
                var blockRight = blockLeft + block.offsetWidth;

                var hasCollide = false;

		wallCanvasFabric.forEachObject(function(element) {
                    var imgTop = element.bound.top + canvasRect.top;
                    var imgBottom = element.bound.top + element.bound.height + canvasRect.top;
		    var imgLeft = element.bound.left + canvasRect.left;
		    var imgRight = element.bound.left + element.bound.width + canvasRect.left;

		    if (!(blockTop > imgBottom || blockBottom < imgTop || blockLeft > imgRight || blockRight < imgLeft)) {
		        hasCollide = true;
		    }
	        });
		if (hasCollide) {
		    collide = true;
		}
		else {
		    collide = false;
		}
		hasCollide = false;
	    }

	    function blockDragOver(e) {
		e.preventDefault();
                console.log("dragover");
	    }

	    function blockDragEnter(e) {
	        console.log("dragenter");
	    }

	    function blockDragLeave(e) {
	    }

            function blockDrop(e) {
	        var block = document.querySelector("img.current-img-dragged");

                //console.log(e.clientX);
		//console.log(e.clientY);


                var canvasRect = wallCanvas.getBoundingClientRect();

                //console.log(canvasRect.left);
		//console.log(canvasRect.top);

                var dropX;
		var dropY;

		if (e.clientX - canvasRect.left < block.offsetWidth / 2) {
	 	    dropX = 0;
		} // deal with left border, let block snap in
		else if (canvasRect.right - e.clientX < block.offsetWidth / 2) {
		    dropX = wallCanvasContainer.offsetWidth - block.offsetWidth; 
		} // deal with right border, let block snap in
		else {
		    dropX = e.clientX - block.offsetWidth / 2 - canvasRect.left;
		}
		if (e.clientY - canvasRect.top < block.offsetHeight / 2) {
	            dropY = 0; 
		} // deal with top border, let block snap in
		else if (canvasRect.bottom - e.clientY < block.offsetHeight / 2) {
		    dropY = wallCanvasContainer.offsetHeight - block.offsetHeight;
		} // deal with bottom border, let block snap in
		else {
		    dropY = e.clientY - block.offsetHeight / 2 - canvasRect.top;
		}

                console.log(collide);

                //var dropX = e.clientX - canvasRect.left;
                //var dropY = e.clientY - canvasRect.top;
                if (collide == false) {
		    var newImage = new fabric.Image(block, {
	                width: block.width,
		        height: block.height,
		        left: dropX,
		        top: dropY,
		        hasControls: false
		});

		newImage.bound = newImage.getBoundingRect();

		wallCanvasFabric.add(newImage);
		}
	    }

            function blockDragEnd(event) {
	    }

            var collide = false;

	    var wallCanvas = document.getElementById("wall-canvas");

	    var genWallCanvas = document.getElementById("gen-wall-canvas");
	   
	    genWallCanvas.addEventListener("click", createCanvas, false);

            var wallCanvasFabric = new fabric.Canvas("wall-canvas");

            var wallCanvasContainer = document.getElementById("wall-canvas-container");

	    var wallBlocks = document.getElementsByClassName("wall-block"); 

	    [].forEach.call(wallBlocks, function (block) { 
                block.addEventListener("dragstart", blockDragStart, false);
	    	block.addEventListener("dragend", blockDragEnd, false);
	        block.addEventListener("drag", blockDrag, false);	
	    });

            wallCanvasContainer.addEventListener("dragenter", blockDragEnter, false);
	    wallCanvasContainer.addEventListener("dragover", blockDragOver, false);
	    wallCanvasContainer.addEventListener("dragleave", blockDragLeave, false);
	    wallCanvasContainer.addEventListener("drop", blockDrop, false);

	}

        $(document).ready(init);

        </script>
        <link rel="stylesheet" href="shoebox-prototype.css">
        <title>Shoebox-prototype</title>
    </head>

    <body>
        <h3>請輸入牆壁大小：</h3>
        <form id="wall-size" class="form-inline">
            <div class="form-group">
                <label for="wall-width">寬：</label>
                <input id="wall-width" class="form-control" type="number" name="wall-width" placeholder="500" value="500">
            </div>
            <div class="form-group">
                <label for="wall-height">高：</label>
                <input id="wall-height" class="form-control" type="number" name="wall-height" placeholder="500" value="500">
            </div>
            <button id="gen-wall-canvas" class="btn btn-primary" type="button">產生牆壁畫布</button>
        </form>
	<div id="wall-blocks">
            1x1 <img class="wall-block" id="block1x1" src="block1x1.png" draggable="true">
	    1x2 <img class="wall-block" id="block1x2" src="block1x2.png" draggable="true">
	    2x2 <img class="wall-block" id="block2x2" src="block2x2.png" draggable="true">
        </div>
        <div id="wall-canvas-container" class="hidden">
	    <canvas id="wall-canvas" class=""</canvas>
	</div>
    </body>
</html>
